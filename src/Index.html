<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Transportation Helper</title>
  <?!= HtmlService.createHtmlOutputFromFile('css.shared').getContent(); ?>
</head>
<body>
  <div class="app">
    <!-- Navigation Link -->
    <a href="#" id="navLink" class="back">&larr; Back to Service Hub</a>
    <h1>Transportation Helper</h1>

    <!-- ─── Date Selector ─────────────────────────────────────────── -->
    <div id="dateSelector" class="card" style="text-align:center;">
      <h3>Select Date</h3>
      <div class="row" style="display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap;">
        <button class="btn secondary" onclick="selectServerDate(0)">Today</button>
        <button class="btn secondary" onclick="selectServerDate(1)">Tomorrow</button>
        <button class="btn secondary" onclick="showCalendar()">
          <span class="icon" style="margin-right:4px;">📅</span>Choose Date...
        </button>
      </div>
      <div id="calendarContainer" style="margin-top:1rem; display:none;">
        <input type="date" id="customDate" style="max-width:200px;">
        <button class="btn" onclick="pickCustom()">Go</button>
      </div>
    </div>

    <!-- ─── Content Area ───────────────────────────────────────────── -->
    <div id="content">
      <div class="spinner" id="spinner" style="display:none;"></div>
    </div>

    <!-- ─── Actions (hidden by default) ─────────────────────────────── -->
    <div class="actions" id="actions" style="display:none;">
      <button id="createBtn" class="btn">Create Transportation Contracts</button>
    </div>

    <!-- ─── Messages ──────────────────────────────────────────────── -->
    <div id="message" class="msg" style="display:none;"></div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const content = $('#content');
    const spinner = $('#spinner');
    const message = $('#message');
    const createBtn = $('#createBtn');
    const navLink = $('#navLink');
    const actions = $('#actions');
    let selectedDate = null;
    let mainHubUrl = '';

    // ─── UI Helpers ──────────────────────────────────────────────
    function setMsg(html, type) {
      if (!message) return;
      message.style.display = 'block';
      message.className = 'msg ' + (type || '');
      message.innerHTML = html;
      // Hide spinner if visible when message appears
      showSpinner(false);
    }
    function clearMsg() {
      message.style.display = 'none';
      message.textContent = '';
      message.className = 'msg';
    }
    function showSpinner(show) {
      spinner.style.display = show ? 'block' : 'none';
    }

    // ─── Hub Link ────────────────────────────────────────────────
    google.script.run
      .withSuccessHandler(link => {
        mainHubUrl = link || '';
        updateNavLink('hub');
      })
      .getMainHubLink();

    function updateNavLink(mode) {
      if (mode === 'hub') {
        navLink.textContent = '← Back to Service Hub';
        navLink.onclick = e => {
          e.preventDefault();
          if (mainHubUrl) window.open(mainHubUrl, '_top');
        };
      } else if (mode === 'home') {
        navLink.textContent = '← Back';
        navLink.onclick = e => {
          e.preventDefault();
          showHome();
        };
      }
    }

    // ─── Home Screen ─────────────────────────────────────────────
    function showHome() {
      $('#dateSelector').style.display = 'block';
      $('#calendarContainer').style.display = 'none';
      content.innerHTML = '';
      clearMsg();
      showSpinner(false);
      actions.style.display = 'none';
      updateNavLink('hub');
    }

    // ─── Date Selection via Server (accurate) ─────────────────────
    function selectServerDate(offsetDays) {
      clearMsg();
      showSpinner(true);
      google.script.run
        .withSuccessHandler(serverDate => {
          showSpinner(false);
          if (!serverDate) return setMsg('Unable to determine server date.', 'error');
          selectedDate = serverDate;
          proceedToLoadAppointments();
        })
        .withFailureHandler(err => {
          showSpinner(false);
          setMsg('Error retrieving date: ' + err.message, 'error');
        })
        .getServerDate(offsetDays);
    }

    function showCalendar() {
      $('#calendarContainer').style.display = 'block';
    }

    function pickCustom() {
      const val = $('#customDate').value;
      if (!val) return alert('Please pick a date');
      selectedDate = val;
      showSpinner(true);
      proceedToLoadAppointments();
    }

    // ─── Load Appointments ───────────────────────────────────────
    function proceedToLoadAppointments() {
      $('#dateSelector').style.display = 'none';
      updateNavLink('home');
      actions.style.display = 'none'; // hide while loading
      loadAppointments(selectedDate);
    }

    function loadAppointments(dateStr) {
      showSpinner(true);
      clearMsg();
      google.script.run
        .withSuccessHandler(appts => {
          showSpinner(false);
          renderAppointments(appts || []);
        })
        .withFailureHandler(err => {
          showSpinner(false);
          setMsg('Error loading appointments: ' + err.message, 'error');
        })
        .getTransportAppointments(dateStr);
    }

    // ─── Render Cards ────────────────────────────────────────────
    function esc(str) {
      return (str || '').replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }

    function renderAppointments(appts) {
      content.innerHTML = '';
      if (!appts.length) {
        content.innerHTML = '<p style="text-align:center;">No transport appointments found for this date.</p>';
        actions.style.display = 'none';
        return;
      }

      appts.forEach(a => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <h2>${esc(a.petName || 'Unnamed Pet')}</h2>
          <div class="field"><label>Client:</label><div>${esc(a.name)}</div></div>
          <div class="address-bubble">${esc(a.address1)}<br>${esc(a.address2)}</div>
          <div class="phone-bubble">${esc(a.phone || '(no phone)')}</div>
          <div class="field"><label>Pet Info:</label><div>${esc(a.speciesBreed || '')}</div></div>
          <div class="field"><label>Details:</label><div>${esc(a.ageSexColor || '')}</div></div>
          <div class="field"><label>Appointment Type:</label><div><em>${esc(a.apptType || '')}</em></div></div>
          <div class="field"><label>Date:</label><div>${esc(a.date || '')}</div></div>
        `;
        content.appendChild(div);
      });

      // show the Create button when appointments exist
      actions.style.display = 'block';
      createBtn.disabled = false;
    }

    // ─── Create Transportation Contracts ─────────────────────────
    createBtn.addEventListener('click', () => {
      clearMsg();
      showSpinner(true);
      createBtn.disabled = true;
      createBtn.textContent = 'Creating...';
      google.script.run
        .withSuccessHandler(res => {
          showSpinner(false);
          createBtn.disabled = false;
          createBtn.textContent = 'Create Transportation Contracts';

          if (!res || !res.ok) {
            setMsg(res?.message || 'Something went wrong.', 'error');
            return;
          }

          if (res.merged && res.merged.url) {
            const fileUrl = res.merged.url;
            const linkHtml = `
              <div>
                <strong>Transportation contracts created successfully!</strong><br><br>
                <a href="${fileUrl}" target="_blank" class="btn" download>⬇️ Download Forms</a>
              </div>
            `;
            setMsg(linkHtml, 'success');
            // Automatically open the merged PDF in a new tab
            window.open(fileUrl, '_blank');
          } else {
            setMsg('Created but merge file missing or unavailable.', 'error');
          }
        })
        .withFailureHandler(err => {
          showSpinner(false);
          createBtn.disabled = false;
          createBtn.textContent = 'Create Transportation Contracts';
          setMsg('Error: ' + err.message, 'error');
        })
        .createTransportContracts(selectedDate);
    });

    // ─── Init ────────────────────────────────────────────────────
    window.addEventListener('load', showHome);
  </script>
</body>
</html>