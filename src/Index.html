<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Transportation Helper</title>
  <?!= HtmlService.createHtmlOutputFromFile('css.shared').getContent(); ?>
</head>
<body>
  <div class="app">
    <a href="#" id="navLink" class="back">&larr; Back to Service Hub</a>
    <h1>Transportation Helper</h1>

    <div id="dateSelector" class="card" style="text-align:center;">
      <h3>Select Date</h3>
      <div class="row" style="display:flex; gap:0.5rem; justify-content:center;">
        <button class="btn secondary" onclick="chooseDate('today')">Today</button>
        <button class="btn secondary" onclick="chooseDate('tomorrow')">Tomorrow</button>
        <button class="btn secondary" onclick="showCalendar()">Choose Date...</button>
      </div>
      <div id="calendarContainer" style="margin-top:1rem; display:none;">
        <input type="date" id="customDate">
        <button class="btn" onclick="pickCustom()">Go</button>
      </div>
    </div>

    <div id="content"><div id="spinner" class="spinner" style="display:none;"></div></div>
    <div class="actions">
      <button id="createBtn" class="btn" disabled>Create Transportation Contracts</button>
    </div>
    <div id="message" class="msg" style="display:none;"></div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    let selectedDate = null;
    let hubLink = '';

    // Helpers
    function msg(text, type) {
      const m = $('#message');
      m.textContent = text;
      m.className = 'msg ' + (type || '');
      m.style.display = 'block';
    }
    function spin(show) {
      const el = document.querySelector('#spinner');
      if (el) el.style.display = show ? 'block' : 'none';
    }

    google.script.run.withSuccessHandler(link => {
      hubLink = link || '';
      $('#navLink').onclick = e => {
        e.preventDefault();
        if (hubLink) window.open(hubLink, '_top');
      };
    }).getMainHubLink();

    function chooseDate(which) {
      const now = new Date();
      const offset = now.getTimezoneOffset() * 60000;
      const localNow = new Date(now.getTime() + offset);
      let d = localNow;
      if (which === 'tomorrow') d = new Date(localNow.getTime() + 86400000);
      selectedDate = d.toISOString().split('T')[0];
      load(selectedDate);
    }

    function showCalendar() {
      $('#calendarContainer').style.display = 'block';
    }

    function pickCustom() {
      const val = $('#customDate').value;
      if (!val) return alert('Pick a date');
      selectedDate = val;
      load(selectedDate);
    }

    function load(dateStr) {
      spin(true);
      $('#dateSelector').style.display = 'none';
      $('#createBtn').disabled = false;
      google.script.run
        .withSuccessHandler(appts => {
          spin(false);
          render(appts);
        })
        .withFailureHandler(e => {
          spin(false);
          msg('Error loading appointments: ' + e.message, 'error');
        })
        .getTransportAppointments(dateStr);
    }

    function render(appts) {
      const c = $('#content');
      c.innerHTML = '';
      if (!appts || !appts.length) {
        c.innerHTML = `<p style="text-align:center;">No transport appointments for ${selectedDate}.</p>`;
        return;
      }
      appts.forEach(a => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <h2>${a.petName || 'Unnamed Pet'}</h2>
          <div class="field"><label>Client:</label><div>${a.name}</div></div>
          <div class="field"><label>Address:</label><div>${a.address1}<br>${a.address2}</div></div>
          <div class="field"><label>Phone:</label><div>${a.phone}</div></div>
          <div class="field"><label>Species / Breed:</label><div>${a.speciesBreed}</div></div>
          <div class="field"><label>Details:</label><div>${a.ageSexColor}</div></div>
          <div class="field"><label>Type:</label><div>${a.apptType}</div></div>
          <div class="field"><label>Date:</label><div>${a.date}</div></div>
        `;
        c.appendChild(div);
      });
    }

    $('#createBtn').onclick = () => {
      if (!selectedDate) return msg('Select a date first.', 'error');
      spin(true);
      msg('');
      $('#createBtn').disabled = true;
      google.script.run
        .withSuccessHandler(res => {
          spin(false);
          $('#createBtn').disabled = false;
          if (!res || !res.ok) return msg(res?.message || 'Failed to create.', 'error');
          msg(`Created ${res.count} contracts. <a href="${res.merged.url}" target="_blank">Open PDF</a>`, 'success');
        })
        .withFailureHandler(e => {
          spin(false);
          $('#createBtn').disabled = false;
          msg('Error: ' + e.message, 'error');
        })
        .createTransportContracts(selectedDate);
    };
  </script>
</body>
</html>